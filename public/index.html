<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tamil Panchangam Calculator</title>
  <link href="https://fonts.googleapis.com/css2?family=Hind+Madurai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Hind Madurai', sans-serif;
      background-color: #FFF9C4;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    .card {
      background-color: #FFF59D;
      border: 1px solid #FFD54F;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .card-header {
      background-color: #FFEB3B;
      padding: 20px;
      text-align: center;
    }
    .card-title {
      color: #D32F2F;
      font-size: 24px;
      margin-bottom: 10px;
    }
    .card-subtitle {
      color: #1A237E;
      font-size: 30px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .card-content {
      padding: 20px;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }
    .form-group {
      flex: 1;
      min-width: 250px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #FFD54F;
      border-radius: 4px;
      background-color: #FFFDE7;
    }
    button {
      background-color: #FF9800;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
      display: block;
      margin: 0 auto;
    }
    button:hover {
      background-color: #F57C00;
    }
    button:disabled {
      background-color: #FFB74D;
      cursor: not-allowed;
    }
    .results {
      margin-top: 20px;
      background-color: white;
      border: 1px solid #FFD54F;
      border-radius: 4px;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px;
      border: 1px solid #FFE082;
      text-align: left;
    }
    th {
      background-color: #FFF59D;
    }
    tr:nth-child(even) {
      background-color: #FFFDE7;
    }
    .footer {
      text-align: center;
      margin-top: 20px;
      color: #616161;
    }
    .error-message {
      background-color: #FFEBEE;
      border: 1px solid #FFCDD2;
      color: #C62828;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
      display: none;
    }
    @media (max-width: 600px) {
      .container {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="card-header">
        <div class="card-title">‡Æì‡ÆÆ‡Øç ‡Æï‡Æ£‡Øá‡Æö‡Ææ‡ÆØ ‡Æ®‡ÆÆ:</div>
        <div class="card-subtitle">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æ™‡Æû‡Øç‡Æö‡Ææ‡Æô‡Øç‡Æï‡ÆÆ‡Øç ‡Æï‡Æ£‡Æø‡Æ™‡Øç‡Æ™‡Ææ‡Æ©‡Øç</div>
        <div>Tamil Panchangam Calculator</div>
      </div>
      <div class="card-content">
        <div class="error-message" id="errorMessage"></div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="date">‡Æ§‡Øá‡Æ§‡Æø‡ÆØ‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç (Select Date)</label>
            <input type="date" id="date">
          </div>
          <div class="form-group">
            <label for="location">‡Æá‡Æü‡Æ§‡Øç‡Æ§‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç (Select Location)</label>
            <select id="location">
              <option value="0">Chennai (13.0827, 80.2707)</option>
              <option value="1">Bangalore (12.9716, 77.5946)</option>
              <option value="2">Delhi (28.6139, 77.2090)</option>
              <option value="3">California (36.7783, 119.4179)</option>
              <option value="4">Atlanta (33.7490, 84.3880)</option>
              <option value="5">London (51.5074, 0.1278)</option>
              <option value="6">Calgary (51.0447, 114.0719)</option>
              <option value="7">Singapore (1.3521, 103.8198)</option>
              <option value="8">Malaysia (4.2105, 101.9758)</option>
            </select>
          </div>
        </div>
        
        <button id="calculateBtn">‡Æ™‡Æû‡Øç‡Æö‡Ææ‡Æô‡Øç‡Æï‡Æ§‡Øç‡Æ§‡Øà‡Æï‡Øç ‡Æï‡Ææ‡Æü‡Øç‡Æü‡ØÅ (Show Panchangam)</button>
        
        <div id="results" class="results" style="display:none;">
          <h2 id="resultTitle" style="text-align:center; color:#1A237E;"></h2>
          <table>
            <thead>
              <tr>
                <th>‡Æµ‡Æï‡Øà (Category)</th>
                <th>‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç (Name)</th>
                <th>‡Æµ‡Æø‡Æµ‡Æ∞‡ÆÆ‡Øç (Value)</th>
              </tr>
            </thead>
            <tbody id="resultTable">
              <!-- Results will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <div class="footer">
      ¬© 2025 Tamil Panchangam Calculator - Powered by Prokerala API
    </div>
  </div>
  
  <script>
    // Locations data
    const LOCATIONS = [
      { name: 'Chennai', latitude: 13.0827, longitude: 80.2707 },
      { name: 'Bangalore', latitude: 12.9716, longitude: 77.5946 },
      { name: 'Delhi', latitude: 28.6139, longitude: 77.2090 },
      { name: 'California', latitude: 36.7783, longitude: 119.4179 },
      { name: 'Atlanta', latitude: 33.7490, longitude: 84.3880 },
      { name: 'London', latitude: 51.5074, longitude: 0.1278 },
      { name: 'Calgary', latitude: 51.0447, longitude: 114.0719 },
      { name: 'Singapore', latitude: 1.3521, longitude: 103.8198 },
      { name: 'Malaysia', latitude: 4.2105, longitude: 101.9758 }
    ];
    
    // Emojis for categories
    const CATEGORY_EMOJIS = {
      'Basic': 'üìå',
      'Day': 'üìÖ',
      'Time': '‚è∞',
      'Nakshatra': '‚≠ê',
      'Tithi': 'üåô',
      'Karana': 'üîÑ',
      'Yoga': 'üßò',
      'Muhurta': '‚ú®'
    };
    
    // Set default date
    document.getElementById('date').valueAsDate = new Date();
    
    // Format date in Tamil
    function formatTamilDate(dateStr) {
      const date = new Date(dateStr);
      try {
        return new Intl.DateTimeFormat('ta-IN', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        }).format(date);
      } catch (e) {
        // Fallback if Tamil locale is not supported
        return date.toLocaleDateString();
      }
    }
    
    // Format time
    function formatTime(timeStr) {
      if (!timeStr) return 'N/A';
      try {
        const [time] = timeStr.split(' ');
        return time;
      } catch {
        return timeStr;
      }
    }
    
    // Show error message
    function showError(message) {
      const errorEl = document.getElementById('errorMessage');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }
    
    // Hide error message
    function hideError() {
      document.getElementById('errorMessage').style.display = 'none';
    }
    
    // Calculate button click handler
    document.getElementById('calculateBtn').addEventListener('click', async function() {
      const dateValue = document.getElementById('date').value;
      const locationIndex = document.getElementById('location').value;
      const selectedLocation = LOCATIONS[locationIndex];
      
      if (!dateValue) {
        showError('Please select a date');
        return;
      }
      
      hideError();
      
      // Display loading state
      this.textContent = '‡Æè‡Æ±‡Øç‡Æ±‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ... (Loading...)';
      this.disabled = true;
      
      try {
        // Option 1: Use OAuth authentication (using server environment variables)
        const response = await fetch('/api/panchang', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            date: dateValue,
            latitude: selectedLocation.latitude,
            longitude: selectedLocation.longitude,
            ayanamsa: 1 // Default to Lahiri
          })
        });
        
        // Alternative Option: Use direct API approach
        /*
        const response = await fetch('/api/panchang-direct', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            date: dateValue,
            latitude: selectedLocation.latitude,
            longitude: selectedLocation.longitude,
            ayanamsa: 1 // Default to Lahiri
          })
        });
        */
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to fetch panchangam data');
        }
        
        const data = await response.json();
        displayResults(data.data, dateValue, selectedLocation);
      } catch (error) {
        showError('Error: ' + error.message);
        
        // Fallback to sample data if API fails
        const useSampleData = true;
        
        if (useSampleData) {
          console.log('Using sample data as fallback');
          const sampleData = {
            datetime: dateValue + "T00:00:00+05:30",
            coordinates: {
              latitude: selectedLocation.latitude,
              longitude: selectedLocation.longitude
            },
            vaara: "‡Æ™‡ØÅ‡Æ§‡Æ©‡Øç",
            sunrise: "06:15:00 +0530",
            sunset: "18:30:00 +0530",
            nakshatra: [
              {
                name: "‡ÆÖ‡Æ∏‡Øç‡Æµ‡Æø‡Æ©‡Æø",
                start: "00:00:00 +0530",
                end: "08:45:00 +0530"
              },
              {
                name: "‡Æ™‡Æ∞‡Æ£‡Æø",
                start: "08:45:00 +0530",
                end: "23:59:59 +0530"
              }
            ],
            tithi: [
              {
                name: "‡Æö‡Æ∑‡Øç‡Æü‡Æø",
                start: "00:00:00 +0530",
                end: "14:20:00 +0530"
              },
              {
                name: "‡Æö‡Æ™‡Øç‡Æ§‡ÆÆ‡Æø",
                start: "14:20:00 +0530",
                end: "23:59:59 +0530"
              }
            ],
            karana: [
              {
                name: "‡Æ™‡Æµ",
                start: "00:00:00 +0530",
                end: "13:45:00 +0530"
              },
              {
                name: "‡Æ™‡Ææ‡Æ≤‡Æµ",
                start: "13:45:00 +0530",
                end: "23:59:59 +0530"
              }
            ],
            yoga: [
              {
                name: "‡Æö‡Æø‡Æ§‡Øç‡Æ§",
                start: "00:00:00 +0530",
                end: "16:30:00 +0530"
              },
              {
                name: "‡Æö‡Ææ‡Æ§‡Øç‡Æ§‡Æø‡ÆØ‡ÆÆ‡Øç",
                start: "16:30:00 +0530",
                end: "23:59:59 +0530"
              }
            ],
            muhurta: {
              rahu: {
                start: "09:15:00 +0530",
                end: "10:45:00 +0530"
              },
              yama: {
                start: "13:30:00 +0530",
                end: "15:00:00 +0530"
              },
              gulika: {
                start: "06:15:00 +0530",
                end: "07:45:00 +0530"
              }
            }
          };
          
          displayResults(sampleData, dateValue, selectedLocation);
        }
      } finally {
        // Reset button
        this.textContent = '‡Æ™‡Æû‡Øç‡Æö‡Ææ‡Æô‡Øç‡Æï‡Æ§‡Øç‡Æ§‡Øà‡Æï‡Øç ‡Æï‡Ææ‡Æü‡Øç‡Æü‡ØÅ (Show Panchangam)';
        this.disabled = false;
      }
    });
    
    // Display results
    function displayResults(data, date, location) {
      // Set result title
      document.getElementById('resultTitle').textContent = 
        `${formatTamilDate(date)} - ${location.name} ‡Æ™‡Æû‡Øç‡Æö‡Ææ‡Æô‡Øç‡Æï‡ÆÆ‡Øç`;
      
      // Clear previous results
      const resultTable = document.getElementById('resultTable');
      resultTable.innerHTML = '';
      
      // Process data
      const rows = [];
      
      // Add basic info
      if (data.datetime) {
        rows.push({ 
          category: 'Basic', 
          name: '‡Æ§‡Øá‡Æ§‡Æø (Date)', 
          value: formatTamilDate(data.datetime)
        });
      }
      
      // Add coordinates
      if (data.coordinates) {
        rows.push({ 
          category: 'Basic', 
          name: '‡ÆÜ‡ÆØ‡Æï‡Øç‡Æï‡Øã‡Æü‡ØÅ‡Æï‡Æ≥‡Øç (Coordinates)', 
          value: `${data.coordinates.latitude}, ${data.coordinates.longitude}`
        });
      }
      
      // Add weekday
      if (data.vaara) {
        rows.push({ 
          category: 'Day', 
          name: '‡Æï‡Æø‡Æ¥‡ÆÆ‡Øà (Weekday)', 
          value: data.vaara
        });
      }
      
      // Add sunrise and sunset
      if (data.sunrise) {
        rows.push({ 
          category: 'Time', 
          name: '‡Æö‡ØÇ‡Æ∞‡Æø‡ÆØ ‡Æâ‡Æ§‡ÆØ‡ÆÆ‡Øç (Sunrise)', 
          value: formatTime(data.sunrise)
        });
      }
      
      if (data.sunset) {
        rows.push({ 
          category: 'Time', 
          name: '‡Æö‡ØÇ‡Æ∞‡Æø‡ÆØ ‡ÆÖ‡Æ∏‡Øç‡Æ§‡ÆÆ‡Æ©‡ÆÆ‡Øç (Sunset)', 
          value: formatTime(data.sunset)
        });
      }
      
      // Process array-based properties
      const arrayProps = [
        { key: 'nakshatra', label: '‡Æ®‡Æü‡Øç‡Æö‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡ÆÆ‡Øç (Nakshatra)' },
        { key: 'tithi', label: '‡Æ§‡Æø‡Æ§‡Æø (Tithi)' },
        { key: 'karana', label: '‡Æï‡Æ∞‡Æ£‡ÆÆ‡Øç (Karana)' },
        { key: 'yoga', label: '‡ÆØ‡Øã‡Æï‡ÆÆ‡Øç (Yoga)' }
      ];
      
      arrayProps.forEach(({ key, label }) => {
        if (data[key] && Array.isArray(data[key])) {
          data[key].forEach(item => {
            const timeInfo = item.start && item.end
              ? `${formatTime(item.start)} - ${formatTime(item.end)}`
              : '‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç ‡Æï‡Æø‡Æü‡Øà‡Æï‡Øç‡Æï‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà (Time not available)';
            
            rows.push({ 
              category: key.charAt(0).toUpperCase() + key.slice(1), 
              name: `${item.name}`, 
              value: timeInfo
            });
          });
        }
      });
      
      // Add muhurtas
      if (data.muhurta) {
        const muhurtaTranslations = {
          rahu: '‡Æ∞‡Ææ‡Æï‡ØÅ ‡Æï‡Ææ‡Æ≤‡ÆÆ‡Øç (Rahu Kalam)',
          yama: '‡Æé‡ÆÆ‡Æï‡Æ£‡Øç‡Æü‡ÆÆ‡Øç (Yama Gandam)',
          gulika: '‡Æï‡ØÅ‡Æ≥‡Æø‡Æï‡Øà (Gulikai)'
        };
        
        Object.entries(data.muhurta).forEach(([key, value]) => {
          if (value.start && value.end) {
            rows.push({ 
              category: 'Muhurta', 
              name: muhurtaTranslations[key] || key, 
              value: `${formatTime(value.start)} - ${formatTime(value.end)}`
            });
          }
        });
      }
      
      // Add rows to table
      rows.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.style.backgroundColor = index % 2 === 0 ? '#FFFDE7' : 'white';
        
        const categoryCell = document.createElement('td');
        categoryCell.className = 'font-medium';
        categoryCell.textContent = `${CATEGORY_EMOJIS[item.category] || 'üîç'} ${item.category}`;
        
        const nameCell = document.createElement('td');
        nameCell.textContent = item.name;
        
        const valueCell = document.createElement('td');
        valueCell.textContent = item.value;
        
        tr.appendChild(categoryCell);
        tr.appendChild(nameCell);
        tr.appendChild(valueCell);
        
        resultTable.appendChild(tr);
      });
      
      // Show results
      document.getElementById('results').style.display = 'block';
    }
  </script>
</body>
</html>